# AI-Anchor 离线模式使用指南

## 问题解决

### Token not found 错误解决方案

如果您在视频合成时遇到"Token not found"错误，这通常是因为程序尝试连接云端服务器但网络连接失败。我们已经修改了代码以支持完全离线运行。

## 离线模式功能

### 已实现的离线功能

1. **自动离线检测**: 程序启动时会自动检测网络连接状态
2. **本地服务器优先**: 优先使用本地部署的AI模型
3. **网络请求容错**: 网络请求失败时自动切换到离线模式
4. **用户认证跳过**: 离线模式下跳过云端用户认证
5. **错误信息优化**: 提供更友好的离线模式错误提示

### 修改的文件

1. **src/service/PermissionService.ts**: 跳过云端服务器权限检查
2. **electron/mapi/server/api.ts**: 增加网络请求容错处理
3. **electron/mapi/user/main.ts**: 提供离线用户认证回退
4. **src/config.ts**: 添加离线模式配置
5. **src/lib/offline.ts**: 新增离线模式工具类
6. **src/lib/error.ts**: 优化错误信息提示
7. **src/main.ts**: 启动时初始化离线模式检测

## 使用方法

### 1. 确保使用本地模型

- 只使用 `EnumServerType.LOCAL` 或 `EnumServerType.LOCAL_DIR` 类型的服务器
- 避免使用 `EnumServerType.CLOUD` 云端服务器
- 将模型文件放在 `model/` 目录下

### 2. 本地模型配置

在 `model/your-model/config.json` 中确保配置正确：

```json
{
  "name": "your-model-name",
  "version": "1.0.0",
  "title": "您的模型标题",
  "type": "local",
  "functions": ["videoGen", "soundTts"],
  "settings": [...],
  "setting": {...}
}
```

### 3. 启动离线模式

程序会自动检测网络状态：

- **自动模式**: 程序启动时自动检测网络并切换模式
- **手动启用**: 在代码中调用 `OfflineMode.enable()`
- **强制离线**: 在 `src/config.ts` 中设置 `return true` 强制启用离线模式

### 4. 视频生成流程

1. 选择本地部署的模型服务器
2. 确保服务器状态为"运行中"
3. 上传或选择音频文件
4. 选择视频模板
5. 开始视频生成

## 故障排除

### 常见问题

1. **"Token not found" 错误**
   - 解决方案: 使用本地模型而非云端模型
   - 检查服务器类型是否为 `local`

2. **"Network unavailable" 错误**
   - 解决方案: 程序已自动切换到离线模式
   - 继续使用本地功能即可

3. **模型无法启动**
   - 检查模型文件是否完整
   - 确认 `config.json` 配置正确
   - 查看模型日志文件

### 调试信息

离线模式启用后，控制台会显示：
```
AI-Anchor启动在离线模式 - 只能使用本地模型
```

网络请求失败时会显示：
```
Network request failed, running in offline mode: [错误详情]
```

## 技术细节

### 离线模式检测机制

1. 程序启动时尝试访问网络
2. 如果网络请求失败，自动启用离线模式
3. 后续所有网络相关操作都会跳过或使用本地回退

### 本地服务器支持

- **MuseTalk**: 本地数字人视频生成
- **CosyVoice**: 本地语音合成
- **EasyServer**: 通用本地服务器框架

### 数据存储

- 用户数据: 本地存储，不依赖云端同步
- 模型配置: 本地 JSON 文件
- 生成结果: 本地文件系统

## 性能优化建议

1. **硬件要求**
   - GPU: 推荐使用独立显卡加速
   - 内存: 建议16GB以上
   - 存储: SSD固态硬盘

2. **模型优化**
   - 使用量化模型减少内存占用
   - 定期清理临时文件
   - 关闭不必要的后台服务

3. **系统配置**
   - 关闭防病毒软件实时扫描
   - 设置高性能电源模式
   - 确保充足的磁盘空间

## 更新日志

- ✅ 修复 "Token not found" 错误
- ✅ 实现完全离线运行
- ✅ 优化错误提示信息
- ✅ 添加自动网络检测
- ✅ 支持本地模型优先

## 联系支持

如果您在使用离线模式时遇到问题，请：

1. 查看控制台日志信息
2. 检查模型配置文件
3. 确认模型文件完整性
4. 提供详细的错误信息

现在您可以完全离线使用AI-Anchor进行视频生成，无需担心网络连接问题！ 
